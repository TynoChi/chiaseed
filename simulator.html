<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://placehold.co/192x192/0b5cab/ffffff?text=E"/>
  <link rel="stylesheet" href="assets/calculator/calculator.css">

  <!-- TinyMCE for Word-style rich text -->
  <script src="https://cdn.tiny.cloud/1/rzryz1ox9nz2xu937t4vhv7s90dz7jjvff27kbobdx9ng14r/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

  <!-- html2canvas + jsPDF for PDF export -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Custom Theme Variables (ICA-style) */
    :root {
      /* Core palette (Standard theme) - Matches style.css */
      --bg: #f5f6f8;
      --surface: #ffffff;
      --surface-soft: #f3f4f6; /* Used for table headers/alt rows in legacy */
      --text: #1f2937;
      --muted: #6b7280;

      --primary: #0b5cab;
      --primary-contrast: #ffffff;
      --primary-hover: #094a88;
      
      --secondary: #f07f0f; /* Orange (kept from index.html) */

      --border: #e5e7eb;
      --border-strong: #d1d5db;

      --table-header-bg: #f3f4f6;
      --table-row-alt: #f9fafb;

      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    /* High Contrast Themes */
    .theme-hc-white {
      --text: #ffffff;
      --background: #000000;
      --surface: #1a1a1a;
      --surface-soft: #2c2c2c;
      --border-strong: #666666;
      --table-header-bg: #333333;
    }
    .theme-hc-yellow {
      --text: #ffff00;
      --background: #000000;
      --surface: #1a1a1a;
      --surface-soft: #2c2c2c;
      --border-strong: #666666;
      --table-header-bg: #333333;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--background);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
    }

    /* General Layout */
    main {
      padding: 20px;
      min-height: calc(100vh - 120px); /* Account for header and footer */
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Landing / Selection Page Styles (Matching AF.html/style.css) */
    .landing-container {
        text-align: center;
        max-width: 600px;
        margin: 60px auto;
        padding: 40px;
        background-color: var(--surface);
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .landing-container h1 {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 2rem;
        font-weight: 700;
    }
    .landing-container p {
        margin-bottom: 30px;
        color: var(--text);
        font-size: 1.1rem;
    }
    .exam-selection-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .exam-select-btn {
        background-color: var(--surface);
        color: var(--primary);
        border: 2px solid var(--primary);
        padding: 15px 20px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .exam-select-btn:hover {
        background-color: var(--primary);
        color: white;
    }

    /* Header */
    header {
      background-color: var(--surface);
      border-bottom: 1px solid var(--border-strong);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .logo {
      height: 40px;
    }
    .timer {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary);
    }
    
    /* Theme Switcher */
    .theme-switcher-group {
      display: flex;
      border: 1px solid var(--border-strong);
      border-radius: 0.5rem;
      overflow: hidden;
    }
    .theme-option {
      padding: 4px 10px;
      cursor: pointer;
      font-size: 0.875rem;
      user-select: none;
      background-color: var(--surface-soft);
      border-left: 1px solid var(--border-strong);
    }
    .theme-option:first-child { border-left: none; }
    .theme-switcher-group input[type="radio"] { display: none; }
    .theme-switcher-group input[type="radio"]:checked + label {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
    }
    .theme-switcher {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .theme-switcher-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
    }

    /* Question Container */
    .question-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .question-header {
      background-color: transparent;
      color: var(--primary);
      padding: 0 0 15px 0;
      font-size: 1.5rem;
      font-weight: bold;
      border-bottom: 1px solid var(--border);
      border-radius: 0;
      box-shadow: none;
    }
    .question-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    @media (min-width: 1024px) {
      .question-content {
        flex-direction: row;
      }
    }
    .question-details, .question-proforma {
      background-color: var(--surface);
      padding: 20px;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      flex: 1;
    }
    .question-proforma {
      flex: 1.5; /* Proforma takes up more space */
    }

    /* Typography inside content */
    h3 {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text);
      margin-top: 15px;
      margin-bottom: 10px;
    }
    .question-section p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* Traditional Table Proforma */
    .proforma-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px;
      background: var(--surface);
    }
    .proforma-table td, .proforma-table th {
      border: 1px solid var(--border);
      padding: 8px;
      vertical-align: top;
    }
    /* Header rows in proforma table (legacy pilot.json uses tr.header-row) */
    .proforma-table .header-row td {
      background-color: var(--table-header-bg);
      font-weight: bold;
    }
    .proforma-table .subheader-row td {
      background-color: var(--surface-soft);
      font-weight: 600;
      font-style: italic;
    }

    .proforma-table input[type="text"] {
      width: 95%;
      padding: 7px 9px;
      border: 1px solid var(--border-strong); /* RESTORED BORDER */
      border-radius: 4px;
      background: var(--surface); /* RESTORED BACKGROUND */
      color: var(--text);
      text-align: right;
      font: inherit;
    }
    .proforma-table .bold-row td {
      font-weight: bold;
      border-top: 3px double var(--border-strong); /* Legacy style often uses double border for totals */
    }
    .proforma-table td:last-child {
      width: 30%;
      text-align: right;
    }
    .proforma-table input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11,92,171,0.15);
      outline: none;
    }
    
    /* Standard Data Tables (Question Details) */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
    .data-table th, .data-table td {
        border: 1px solid var(--border-strong);
        padding: 8px;
        text-align: left;
    }
    .data-table th {
        background-color: var(--table-header-bg);
        font-weight: bold;
    }
    .data-table td:not(:first-child) {
        text-align: right;
    }


    /* === Excel Grid Styling === */
    .excel-grid {
      overflow: auto; /* Allow scrolling both ways inside the container */
      max-height: 75vh; /* Constrain height to viewport */
      width: 100%;
      background-color: var(--surface);
      border: 1px solid var(--border-strong);
      position: relative;
    }
    .excel-grid table {
      border-collapse: collapse;
      width: max-content; /* Allow table to grow naturally */
      min-width: 100%;
      font-size: 0.9rem;
      table-layout: fixed;
    }
    .excel-grid th {
      background-color: var(--table-header-bg);
      border: 1px solid var(--border-strong);
      padding: 4px;
      font-weight: bold;
      text-align: center;
      color: var(--text);
      position: sticky;
      top: 0;
      z-index: 20; /* Keep header on top */
    }
    .excel-grid td:first-child {
       position: sticky;
       left: 0;
       z-index: 15;
       background-color: var(--surface-soft);
    }
    /* Uniform cells */
    .excel-grid th, 
    .excel-grid td {
      width: 100px; 
      min-width: 100px;
      text-align: center;
    }
    .excel-grid th:first-child,
    .excel-grid td:first-child {
        width: 50px;
        min-width: 50px;
    }
    .excel-grid td {
      border: 1px solid var(--border-strong);
      padding: 0; /* Remove padding so input fills cell */
      height: 28px;
      color: var(--text);
    }
    /* The input is the cell */
    .excel-grid input[type="text"] {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
      padding: 4px 8px;
      font-family: inherit;
      font-size: inherit;
      color: var(--text);
    }
    .excel-grid input:focus {
      outline: 2px solid var(--primary);
      background-color: rgba(11, 92, 171, 0.1);
      z-index: 10;
      position: relative;
    }
    .excel-grid .fixed-cell {
      background-color: var(--surface-soft);
      font-weight: 600;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      color: var(--text);
    }
    .excel-grid .selected-cell {
      background-color: rgba(11, 92, 171, 0.3) !important;
      outline: 2px solid var(--primary);
    }

    /* === Word Rich Text === */
    .word-rich {
      margin-top: 20px;
    }
    .word-rich textarea {
      width: 100%;
      min-height: 500px;
      resize: vertical;
    }
    /* Style for TinyMCE editor container */
    .tox-tinymce {
      border-radius: 0.5rem !important;
    }

    /* Footer */
    footer {
      background-color: var(--surface);
      border-top: 1px solid var(--border-strong);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }
    .utility-buttons, .navigation-buttons {
      display: flex;
      gap: 10px;
    }
    footer button {
      padding: 8px 15px;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 1px solid var(--border-strong);
    }
    .utility-buttons button {
      background-color: var(--surface-soft);
      color: var(--text);
    }
    .nav-btn {
      background-color: var(--primary);
      color: white;
      border: none;
    }
    .nav-btn:hover:not(:disabled) {
      background-color: #084984;
    }
    footer button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      color: #666;
    }
    
    /* Responsive Adjustments for Mobile */
    @media (max-width: 768px) {
        .excel-grid th, .excel-grid td {
            min-width: 80px;
            width: 80px;
        }
    }
  </style>
</head>
<body class="p-0 m-0">
  <a href="#exam-container" class="skip-link sr-only">Skip to main content</a>

  <header>
    <img src="https://tymbaedu.com/wp-content/uploads/2023/02/TYMBA-Horizontal-Orange-New.png" alt="Exam Logo" class="logo" />
    <span id="exam-timer" class="timer font-mono" style="display: none;">00:00:00</span>

    <div class="theme-switcher" role="group" aria-label="Color theme">
      <span class="theme-switcher-label" id="theme-switcher-label">Theme</span>
      <div class="theme-switcher-group" role="radiogroup" aria-labelledby="theme-switcher-label">
        <input type="radio" id="theme-default" name="theme" value="default" aria-label="Standard theme" />
        <label for="theme-default" class="theme-option" title="Standard">Standard</label>
        <input type="radio" id="theme-white" name="theme" value="hc-white" aria-label="White on black" />
        <label for="theme-white" class="theme-option" title="White on Black">White on Black</label>
        <input type="radio" id="theme-yellow" name="theme" value="hc-yellow" aria-label="Yellow on black" />
        <label for="theme-yellow" class="theme-option" title="Yellow on Black">Yellow on Black</label>
      </div>
    </div>
  </header>

  <main id="exam-container">
    <div class="text-center p-8 bg-surface rounded-lg shadow-md max-w-lg mx-auto mt-20">
      <h1 class="text-2xl font-bold mb-4 text-primary">Exam Prototype</h1>
      <p class="mb-6">Click the button below to load the selection screen.</p>
      <button id="load-exam-btn" class="bg-primary text-white py-2 px-6 rounded-lg shadow hover:bg-blue-700 transition duration-150" onclick="location.reload()">Load Selection</button>
    </div>
  </main>
  <div id="calculator-container" class="hidden"></div>

  <footer id="footer-nav" style="display: none;">
    <div class="utility-buttons">
      <button id="calculator-btn" title="Calculator">Calculator</button>
      <button disabled>Note Pad</button>
      <button disabled>Flag</button>
    </div>
    <div class="navigation-buttons">
      <button id="back-btn" class="nav-btn">&lt;&lt; Back</button>
      <button id="next-btn" class="nav-btn">Next &gt;</button>
      <button id="mark-btn" class="nav-btn mark-btn bg-secondary hover:bg-orange-600" style="display: none;">Mark Exam</button>
      <button id="export-pdf-btn" class="nav-btn bg-indigo-700 hover:bg-indigo-800" style="display:none;">
        ðŸ“„ Export Answers to PDF
      </button>
    </div>
  </footer>

  <script type="module">
    import { activeConfig as CONFIG } from './assets/js/settings_manager.js';
    
    // Apply Config
    if (CONFIG.platform) {
        if (CONFIG.platform.logoUrl) {
            const logo = document.querySelector('header .logo');
            if (logo) logo.src = CONFIG.platform.logoUrl;
        }
        if (CONFIG.platform.name) {
            document.title = `${CONFIG.platform.name} - Simulator`;
        }
    }

    // === Theme Switcher ===
    (function initTheme() {
      const THEME_KEY = 'icaew_theme_pref';
      const body = document.body;
      const radios = [document.getElementById('theme-default'), document.getElementById('theme-white'), document.getElementById('theme-yellow')];

      function applyTheme(value) {
        body.classList.remove('theme-hc-white', 'theme-hc-yellow');
        if (value === 'hc-white') body.classList.add('theme-hc-white');
        if (value === 'hc-yellow') body.classList.add('theme-hc-yellow');
      }
      const saved = localStorage.getItem(THEME_KEY) || (CONFIG.platform?.theme === 'dark' ? 'hc-white' : 'default');
      applyTheme(saved);
      radios.forEach(r => {
          if (r) {
              r.checked = (r.value === saved);
              r.addEventListener('change', e => {
                const v = e.target.value;
                applyTheme(v);
                localStorage.setItem(THEME_KEY, v);
              });
          }
      });
    })();

    // === Main App Logic ===
    const examContainer = document.getElementById('exam-container');
    const footerNav = document.getElementById('footer-nav');
    const examTimerDisplay = document.getElementById('exam-timer');

    let examData, currentQuestionIndex = 0, userAnswers = {}, userMerges = {}, timerInterval = null;
    let timeLeft = 120 * 60; // 2 hours in seconds
    const examFilesPath = CONFIG.platform?.paths?.json || 'json/';
    
    // --- Excel Merge State ---
    let selectionStart = null;
    let selectionEnd = null;

    window.handleCellMouseDown = function(r, c, qId) {
      selectionStart = { r, c };
      selectionEnd = { r, c };
      updateSelectionVisuals(qId);
    }

    window.handleCellMouseOver = function(r, c, qId) {
      if (selectionStart) {
        selectionEnd = { r, c };
        updateSelectionVisuals(qId);
      }
    }

    window.handleCellMouseUp = function() {
      // selectionStart remains set to allow "Merge" click
    }

    function updateSelectionVisuals(qId) {
       document.querySelectorAll('.selected-cell').forEach(el => el.classList.remove('selected-cell'));
       if (!selectionStart || !selectionEnd) return;
       const minR = Math.min(selectionStart.r, selectionEnd.r);
       const maxR = Math.max(selectionStart.r, selectionEnd.r);
       const minC = Math.min(selectionStart.c, selectionEnd.c);
       const maxC = Math.max(selectionStart.c, selectionEnd.c);
       for(let r=minR; r<=maxR; r++) {
         for(let c=minC; c<=maxC; c++) {
            const id = `${qId}_grid_${r}_${c}`;
            const input = document.getElementById(id);
            if (input) input.classList.add('selected-cell');
         }
       }
    }

    window.mergeSelectedCells = function(qId) {
       if (!selectionStart || !selectionEnd) return;
       const minR = Math.min(selectionStart.r, selectionEnd.r);
       const maxR = Math.max(selectionStart.r, selectionEnd.r);
       const minC = Math.min(selectionStart.c, selectionEnd.c);
       const maxC = Math.max(selectionStart.c, selectionEnd.c);
       const merge = { r: minR, c: minC, rs: maxR - minR + 1, cs: maxC - minC + 1 };
       if (!userMerges[qId]) userMerges[qId] = [];
       userMerges[qId].push(merge);
       selectionStart = null; 
       selectionEnd = null;
       renderQuestion(currentQuestionIndex);
    }

    function getMergeData(qId, r, c) {
      if (!userMerges[qId]) return null;
      return userMerges[qId].find(m => m.r === r && m.c === c);
    }

    function isMergedHidden(qId, r, c) {
      if (!userMerges[qId]) return false;
      return userMerges[qId].some(m => {
         if (m.r === r && m.c === c) return false;
         return r >= m.r && r < m.r + m.rs && c >= m.c && c < m.c + m.cs;
      });
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        const h = String(Math.floor(timeLeft / 3600)).padStart(2, '0');
        const m = String(Math.floor((timeLeft % 3600) / 60)).padStart(2, '0');
        const s = String(timeLeft % 60).padStart(2, '0');
        examTimerDisplay.textContent = `${h}:${m}:${s}`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          alert('Time is up! Exam finished.');
        }
      }, 1000);
      examTimerDisplay.style.display = 'block';
    }

    function saveAnswers() {
      for (const instanceId in tinymce.editors) {
        const editor = tinymce.editors[instanceId];
        const textarea = editor.targetElm;
        const inputId = textarea.dataset.inputId;
        userAnswers[inputId] = editor.getContent();
      }
      examContainer.querySelectorAll('input[type="text"]').forEach(el => {
        const id = el.id || el.dataset.inputId;
        if (id) userAnswers[id] = el.value;
      });
    }

    window.handleGridFocus = function(el) {
        const formula = el.getAttribute('data-formula');
        if (formula) el.value = formula;
    };

    window.handleGridBlur = function(el) {
        const val = el.value.trim();
        const inputId = el.id;
        if (val.startsWith('=')) {
            el.setAttribute('data-formula', val);
            userAnswers[inputId] = val;
        } else {
            el.removeAttribute('data-formula');
            userAnswers[inputId] = val;
        }
        const questionId = inputId.split('_grid_')[0];
        recalculateAllGrid(questionId);
    };

    function recalculateAllGrid(questionId) {
        const inputs = document.querySelectorAll(`input[id^="${questionId}_grid_"]`);
        for (let pass = 0; pass < 3; pass++) {
            inputs.forEach(input => {
                const formula = input.getAttribute('data-formula');
                if (formula) input.value = evaluateFormula(formula, questionId);
            });
        }
    }

    function evaluateFormula(formula, questionId) {
        let expression = formula.substring(1).toUpperCase();
        const getVal = (ref) => {
            const colChar = ref.match(/[A-Z]+/)[0];
            const rowNum = parseInt(ref.match(/[0-9]+/)[0]) - 1;
            let colIndex = 0;
            for (let i = 0; i < colChar.length; i++) colIndex = colIndex * 26 + (colChar.charCodeAt(i) - 64);
            colIndex -= 1;
            const id = `${questionId}_grid_${rowNum}_${colIndex}`;
            const el = document.getElementById(id);
            if (!el) return 0;
            return parseFloat(el.value.replace(/,/g, '')) || 0;
        };
        expression = expression.replace(/SUM\(([A-Z]+[0-9]+):([A-Z]+[0-9]+)\)/g, (match, start, end) => {
            const startColMatch = start.match(/[A-Z]+/)[0];
            const startRow = parseInt(start.match(/[0-9]+/)[0]);
            const endColMatch = end.match(/[A-Z]+/)[0];
            const endRow = parseInt(end.match(/[0-9]+/)[0]);
            const getColIdx = (c) => {
                let idx = 0;
                for (let i=0; i<c.length; i++) idx = idx * 26 + (c.charCodeAt(i) - 64);
                return idx - 1;
            };
            const c1 = getColIdx(startColMatch), c2 = getColIdx(endColMatch);
            let sum = 0;
            for (let r = Math.min(startRow, endRow) - 1; r <= Math.max(startRow, endRow) - 1; r++) {
                for (let c = Math.min(c1, c2); c <= Math.max(c1, c2); c++) {
                    const id = `${questionId}_grid_${r}_${c}`;
                    const el = document.getElementById(id);
                    if (el) sum += parseFloat(el.value.replace(/,/g, '')) || 0;
                }
            }
            return sum;
        });
        expression = expression.replace(/[A-Z]+[0-9]+/g, (match) => getVal(match));
        try {
            if (!/^[0-9+\-*/.() ]+$/.test(expression)) return "#ERR";
            return Function('"use strict";return (' + expression + ')')();
        } catch (e) { return "#ERR"; }
    }

    function renderQuestion(index) {
      if (!examData || !examData.questions || index < 0 || index >= examData.questions.length) return;
      for (const instanceId in tinymce.editors) tinymce.editors[instanceId].destroy();
      const question = examData.questions[index];
      let contentHtml = `
        <div class="question-container">
          <div class="question-header">${question.title} (${question.marks} Marks)</div>
          <div class="question-content">
            <div class="question-details">
              ${question.scenario ? `<div class="question-section"><p>${question.scenario}</p></div>` : ''}
              ${question.dataTables ? question.dataTables.map(table => `
                <div class="question-section">
                  <h3>${table.title}</h3>
                  <table class="data-table">
                    <thead><tr>${table.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>
                      ${table.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
                      ${table.totals ? `<tr>${table.totals.map(total => `<td><strong>${total}</strong></td>`).join('')}</tr>` : ''}
                    </tbody>
                  </table>
                </div>`).join('') : ''}
              ${question.additionalInfo ? `<div class="question-section"><h3>Additional Information</h3><ol>${question.additionalInfo.map(info => `<li>${info}</li>`).join('')}</ol></div>` : ''}
              ${question.requirement ? `<div class="question-section"><h3>Requirement</h3><p>${question.requirement}</p></div>` : ''}
            </div>
            <div class="question-proforma">
      `;
      if (question.proformas) {
        question.proformas.forEach(proforma => {
          const proformaTitle = proforma.title || 'Proforma';
          if (!proforma.type || proforma.type === "table") {
            contentHtml += `<div class="question-section"><h3>${proformaTitle}</h3><table class="proforma-table">`;
            proforma.rows.forEach(row => {
              const val = userAnswers[row.inputId] || '';
              if (row.isHeader) contentHtml += `<tr class="header-row"><td colspan="2">${row.label}</td></tr>`;
              else if (row.isSubHeader) contentHtml += `<tr class="subheader-row"><td colspan="2">${row.label}</td></tr>`;
              else contentHtml += `<tr class="${row.isBold ? 'bold-row' : ''}"><td>${row.label}</td><td>${row.isInput ? `<input type="text" data-input-id="${row.inputId}" value="${val}">` : ''}</td></tr>`;
            });
            contentHtml += `</table></div>`;
          } else if (proforma.type === "excel-grid" || proforma.type === "spreadsheet") {
            const gridH = proforma.gridHeight || proforma.rows || 40, gridW = proforma.gridWidth || proforma.cols || 12;
            contentHtml += `<div class="question-section">
              <div style="display:flex; justify-content:space-between; align-items:center;"><h3>${proformaTitle}</h3><button onclick="mergeSelectedCells('${question.id}')" style="padding:4px 10px; background:var(--primary); color:#fff; border-radius:4px; border:none; cursor:pointer;">Merge Cells</button></div>
              <div class="excel-grid"><table><thead><tr><th></th>${proforma.headers ? proforma.headers.map(h => `<th>${h}</th>`).join('') : Array.from({length:gridW}, (_,i)=>`<th>${String.fromCharCode(65+i)}</th>`).join('')}</tr></thead><tbody>`;
            for (let r = 0; r < gridH; r++) {
              contentHtml += `<tr><td class="fixed-cell text-center">${r+1}</td>`;
              for (let c = 0; c < gridW; c++) {
                if (isMergedHidden(question.id, r, c)) continue;
                const merge = getMergeData(question.id, r, c), fixed = proforma.fixedCells?.find(cell => cell.row === r && cell.col === c), uniqueId = `${question.id}_grid_${r}_${c}`, val = userAnswers[uniqueId] || '';
                if (fixed) contentHtml += `<td ${merge?`rowspan="${merge.rs}" colspan="${merge.cs}"`:''} class="fixed-cell">${fixed.value}</td>`;
                else contentHtml += `<td ${merge?`rowspan="${merge.rs}" colspan="${merge.cs}"`:''}><input type="text" id="${uniqueId}" data-input-id="${uniqueId}" value="${val}" style="text-align:center;" onfocus="handleGridFocus(this)" onblur="handleGridBlur(this)" onmousedown="handleCellMouseDown(${r}, ${c}, '${question.id}')" onmouseover="handleCellMouseOver(${r}, ${c}, '${question.id}')" onmouseup="handleCellMouseUp()"></td>`;
              }
              contentHtml += '</tr>';
            }
            contentHtml += '</tbody></table></div></div>';
          } else if (proforma.type === "word-rich" || proforma.type === "word") {
            const savedContent = userAnswers[proforma.inputId] || '';
            contentHtml += `<div class="question-section word-rich"><h3>${proformaTitle}</h3><textarea data-input-id="${proforma.inputId}" id="${proforma.inputId}">${savedContent}</textarea></div>`;
          }
        });
      }
      contentHtml += `</div></div></div>`;
      examContainer.innerHTML = contentHtml;
      updateNavButtons();
      addInputListeners();
      initRichTextEditors();
    }

    function addInputListeners() {
      examContainer.querySelectorAll('input[type="text"]').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const id = e.target.id || e.target.dataset.inputId;
          userAnswers[id] = e.target.value;
        });
      });
    }

    function initRichTextEditors() {
      document.querySelectorAll('.word-rich textarea').forEach(textarea => {
        const inputId = textarea.dataset.inputId;
        tinymce.init({
          selector: `#${inputId}`, height: 560, menubar: false, plugins: 'lists link table code autoresize',
          toolbar: 'undo redo | formatselect | bold italic underline | bullist numlist | table | removeformat | code',
          content_style: "body { font-family: var(--font-family); font-size:14px; color: var(--text); }",
          setup: editor => {
            editor.on('change keyup', () => userAnswers[inputId] = editor.getContent());
            editor.on('init', () => { if (userAnswers[inputId]) editor.setContent(userAnswers[inputId]); });
          }
        });
      });
    }

    function updateNavButtons() {
      document.getElementById('back-btn').disabled = currentQuestionIndex === 0;
      document.getElementById('next-btn').style.display = currentQuestionIndex < examData.questions.length - 1 ? 'inline-block' : 'none';
      document.getElementById('mark-btn').style.display = currentQuestionIndex === examData.questions.length - 1 ? 'inline-block' : 'none';
      document.getElementById('export-pdf-btn').style.display = 'inline-block';
    }

    document.getElementById('next-btn').onclick = () => {
      saveAnswers();
      if (currentQuestionIndex < examData.questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion(currentQuestionIndex);
      }
    };

    document.getElementById('back-btn').onclick = () => {
      saveAnswers();
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion(currentQuestionIndex);
      }
    };

    document.getElementById('mark-btn').onclick = () => {
        saveAnswers();
        document.getElementById('export-pdf-btn').click();
        examContainer.innerHTML = `<div class="text-center p-8 bg-surface rounded-lg shadow-md max-w-lg mx-auto mt-20"><h2 class="text-2xl font-bold mb-4 text-primary">Exam Submitted!</h2><p class="mb-6">Your answers have been saved and submitted for marking. A PDF copy of your answers is downloading.</p><button class="bg-primary text-white py-2 px-4 rounded-lg shadow" onclick="location.reload()">Start New Exam</button></div>`;
        footerNav.style.display = 'none';
        examTimerDisplay.style.display = 'none';
        if (timerInterval) clearInterval(timerInterval);
    };

    document.getElementById('export-pdf-btn').onclick = async () => {
        saveAnswers();
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'), pageWidth = pdf.internal.pageSize.getWidth(), pageHeight = pdf.internal.pageSize.getHeight();
        let yPosition = 15;
        pdf.setFontSize(16); pdf.setFont('helvetica', 'bold');
        pdf.text(`${examData.examTitle || 'Exam Answers'} â€“ Student Submission`, pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 10;
        pdf.setFontSize(10); pdf.setFont('helvetica', 'normal');
        pdf.text(`Generated on: ${new Date().toLocaleString()}`, pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 15;
        const answerContainers = [];
        examData.questions.forEach((q, qIndex) => {
            q.proformas?.forEach(proforma => {
                const container = document.createElement('div');
                container.className = 'p-4 mb-5 bg-white max-w-full';
                let html = `<div style="font-size:16px; font-weight:bold; margin-bottom:12px; color:#0b5cab;">Question ${qIndex + 1}: ${q.title} â€“ Your Answer</div>`;
                if ((proforma.type || 'table') === 'table') {
                    html += '<table style="width:100%; border-collapse:collapse; font-size:14px; color:black;">';
                    proforma.rows.forEach(row => {
                        if (row.isInput) {
                            const userVal = userAnswers[row.inputId] || '(blank)';
                            html += `<tr><td style="border:1px solid #ddd; padding:8px; width:50%; background:#f9f9f9;">${row.label}</td><td style="border:1px solid #ddd; padding:8px; width:50%; text-align:right; font-weight:600;">${userVal}</td></tr>`;
                        }
                    });
                    html += '</table>';
                } else if (proforma.type === 'excel-grid' || proforma.type === 'spreadsheet') {
                    const gridH = proforma.gridHeight || proforma.rows || 40, gridW = proforma.gridWidth || proforma.cols || 12;
                    html += `<table style="border-collapse:collapse; font-size:13px; width:100%; color:black;"><thead><tr><th></th>${proforma.headers ? proforma.headers.map(h => `<th style="border:1px solid #333; background:#e3f2fd; padding:8px;">${h}</th>`).join('') : Array.from({length:gridW}, (_,i)=>`<th style="border:1px solid #333; background:#e3f2fd; padding:8px;">${String.fromCharCode(65+i)}</th>`).join('')}</tr></thead><tbody>`;
                    for (let r = 0; r < gridH; r++) {
                        html += `<tr><td style="border:1px solid #999; padding:4px; background:#f5f5f5;">${r+1}</td>`;
                        for (let c = 0; c < gridW; c++) {
                            const fixed = proforma.fixedCells?.find(x => x.row === r && x.col === c), val = userAnswers[`${q.id}_grid_${r}_${c}`] || '';
                            html += `<td style="border:1px solid #999; padding:8px;">${fixed ? fixed.value : val}</td>`;
                        }
                        html += '</tr>';
                    }
                    html += `</tbody></table>`;
                } else if (proforma.type === 'word-rich' || proforma.type === 'word') {
                    html += `<div style="border:1px solid #ddd; padding:12px; min-height:100px; background:#fafafa; color:black;">${userAnswers[proforma.inputId] || '<p>(No answer provided)</p>'}</div>`;
                }
                container.innerHTML = html; document.body.appendChild(container); answerContainers.push(container);
            });
        });
        for (const el of answerContainers) {
            if (yPosition > pageHeight - 40) { pdf.addPage(); yPosition = 20; }
            try {
                const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png'), imgWidth = pageWidth - 20, imgHeight = (canvas.height * imgWidth) / canvas.width;
                if (yPosition + imgHeight > pageHeight - 20) { pdf.addPage(); yPosition = 20; }
                pdf.addImage(imgData, 'PNG', 10, yPosition, imgWidth, imgHeight);
                yPosition += imgHeight + 12;
            } catch (err) { console.error(err); }
            el.remove();
        }
        pdf.save(`${examData.examTitle?.replace(/[^a-z0-9]/gi, '_') || 'Exam'}_Answers_${new Date().toISOString().slice(0,10)}.pdf`);
    };

    async function initExamSelection() {
        examContainer.innerHTML = `<div class="landing-container"><h1>Welcome</h1><p>Loading available exams...</p></div>`;
        try {
            const response = await fetch(`${examFilesPath}sets.json`);
            if (!response.ok) throw new Error('Failed to load sets');
            const sets = await response.json();
            examContainer.innerHTML = `<div class="landing-container"><h1>Welcome</h1><p>Please choose an exam set.</p><div class="exam-selection-list">${sets.map(set => `<button class="exam-select-btn" data-file="${set.filename}">${set.name}</button>`).join('')}</div></div>`;
            examContainer.querySelectorAll('.exam-select-btn').forEach(btn => btn.onclick = () => loadExam(btn.dataset.file));
        } catch (err) { examContainer.innerHTML = `<div class="landing-container"><h1>Error</h1><p>${err.message}</p></div>`; }
    }

    async function loadExam(filename) {
        examContainer.innerHTML = `<div class="text-center p-8 bg-surface mt-20"><p>Loading Exam...</p></div>`;
        try {
            const response = await fetch(`${examFilesPath}${filename}.json`);
            if (!response.ok) throw new Error(`File not found: ${filename}.json`);
            examData = await response.json();
            currentQuestionIndex = 0; userAnswers = {}; renderQuestion(currentQuestionIndex);
            footerNav.style.display = 'flex'; startTimer();
            history.pushState({ mode: 'exam', filename }, "", `#${filename}`);
        } catch (err) {
             examContainer.innerHTML = `<div class="text-center p-8 bg-red-50 text-red-600 mt-20"><h2 class="font-bold">Error</h2><p>${err.message}</p><button class="mt-4 bg-primary text-white py-2 px-4 rounded" onclick="initExamSelection()">Back</button></div>`;
        }
    }

    window.onpopstate = (event) => {
        if (!event.state || !event.state.mode) {
            if (timerInterval) clearInterval(timerInterval);
            footerNav.style.display = 'none'; examTimerDisplay.style.display = 'none';
            initExamSelection();
        }
    };

    initExamSelection();
  </script>
</body>
</html>
