<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChiaSeed - Question Editor (Universal)</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
            --surface: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.75rem;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        /* --- LAYOUT --- */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.95);
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }

        h1 {
            margin: 0;
            font-size: 1.75rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        p { color: var(--secondary); font-size: 0.95rem; }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .main-grid { display: flex; flex-direction: column; }
            .sidebar { width: 100%; }
        }

        /* --- CARDS --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .card-title {
            margin-top: 0;
            margin-bottom: 1.25rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 2px solid var(--light);
            padding-bottom: 0.75rem;
        }

        /* --- TABS --- */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            white-space: nowrap;
        }

        .tab:hover { color: var(--primary); background: var(--light); }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.05));
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- FORMS --- */
        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.85rem;
            text-transform: uppercase; color: var(--secondary);
        }
        .form-control, .textarea-control {
            width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem;
            font-family: inherit; font-size: 0.95rem; background: #f8fafc;
        }
        .form-control:focus, .textarea-control:focus {
            outline: none; border-color: var(--primary); background: white;
        }

        .file-upload-area {
            border: 2px dashed var(--border); padding: 2rem; text-align: center;
            border-radius: var(--radius); background: #f8fafc; cursor: pointer;
        }
        .file-upload-area:hover { border-color: var(--primary); background: #eef2ff; }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem;
            border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; gap: 0.5rem;
        }
        .btn-primary { background: var(--gradient); color: white; }
        .btn-secondary { background: white; border: 2px solid var(--border); color: var(--secondary); }
        .btn-success { background: var(--success); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-light { background: var(--light); color: var(--dark); border: 1px solid var(--border); }
        .btn-icon { padding: 0.5rem; width: 36px; height: 36px; border-radius: 50%; }
        .btn-group { display: flex; gap: 0.75rem; }

        /* --- QUESTION LIST --- */
        .question-card {
            background: white; border: 1px solid var(--border); border-radius: var(--radius);
            padding: 1.5rem; margin-bottom: 1.5rem; position: relative;
            border-left: 4px solid transparent; transition: transform 0.2s;
        }
        .question-card:hover { border-left-color: var(--primary); box-shadow: var(--shadow-md); transform: translateX(4px); }

        .question-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
            padding-bottom: 1rem; border-bottom: 1px solid var(--light);
        }
        
        .tag {
            display: inline-block; background: #e2e8f0; padding: 2px 8px; border-radius: 4px; 
            font-size: 0.75rem; margin-right: 5px; font-weight: bold; text-transform: uppercase;
        }

        /* MCQ Styles */
        .options-list { display: flex; flex-direction: column; gap: 0.5rem; margin: 1rem 0; }
        .option-item {
            display: flex; align-items: flex-start; gap: 1rem; padding: 0.75rem;
            background: var(--light); border: 1px solid var(--border); border-radius: 0.5rem;
        }
        .option-item.correct {
            background: #ecfdf5; border-color: var(--success); color: #064e3b;
        }
        .option-letter {
            font-weight: bold; background: white; border: 1px solid var(--border);
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; flex-shrink: 0;
        }
        .option-item.correct .option-letter { background: var(--success); color: white; border-color: var(--success); }

        /* Nested/Sub-Question Styles */
        .sub-questions-container { margin-top: 1rem; border-left: 2px solid var(--border); padding-left: 1rem; }
        .sub-question-card {
            background: #fafafa; border: 1px solid #eee; padding: 0.75rem;
            margin-bottom: 0.5rem; border-radius: 0.5rem; font-size: 0.9rem;
        }

        /* Explanation Box */
        .explanation-box { 
            margin-top: 1rem; padding: 1rem; border-radius: 0.5rem; 
            font-size: 0.9rem; border: 1px solid #a7f3d0; background: #ecfdf5; color: #065f46; 
        }

        /* --- MODAL --- */
        .edit-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .edit-modal.active { display: flex; }
        .modal-content {
            background: white; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;
            border-radius: var(--radius); padding: 0; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 2rem; overflow-y: auto; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem; background: #f8fafc; }

        .option-editor { margin-bottom: 0.75rem; border: 1px solid var(--border); padding: 0.75rem; border-radius: 0.5rem; }
        .radio-label { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; margin-bottom: 0.5rem; cursor: pointer; }

        /* --- UTILS --- */
        #alert-container { position: fixed; top: 5rem; right: 2rem; z-index: 2000; width: 350px; }
        .alert { padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem; background: white; border-left: 4px solid transparent; box-shadow: var(--shadow-md); }
        .alert-success { border-left-color: var(--success); }
        .alert-error { border-left-color: var(--danger); }
        .alert-info { border-left-color: var(--info); }

        .code-output {
            background: #1e293b; color: #a7f3d0; padding: 1.5rem; border-radius: 0.5rem;
            font-family: monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto;
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; padding: 1rem; border-radius: 0.5rem; text-align: center; border: 2px solid var(--border); }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--secondary); text-transform: uppercase; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>üå± ChiaSeed Editor</h1>
            <p>Universal Question Bank Editor (JSON & XML)</p>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <div class="main-grid">
            
            <!-- Sidebar: Controls -->
            <div class="sidebar">
                
                <!-- File Operations Card -->
                <div class="card">
                    <h2 class="card-title">File Operations</h2>
                    
                    <!-- Drag Drop Zone -->
                    <div class="form-group">
                        <div class="file-upload-area" id="fileDropZone">
                            <p style="margin-bottom: 0.5rem;">Drag & drop file here</p>
                            <label for="fileInput" class="btn btn-light btn-sm">Browse Files</label>
                            <input type="file" id="fileInput" accept=".json, .txt, .xml" style="display: none;">
                        </div>
                    </div>

                    <!-- Preview Area (Hidden by default) -->
                    <div id="dataPreview" style="display: none; margin: 1rem 0; padding: 1rem; background: var(--light); border-radius: 0.5rem;">
                        <h4 style="margin-bottom:0.5rem;">Preview</h4>
                        <div id="previewContent" style="font-size: 0.9rem; margin-bottom:0.5rem;"></div>
                        <button class="btn btn-primary" id="confirmLoadBtn" style="width: 100%;">Confirm Load</button>
                    </div>

                    <!-- Paste Area -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label class="form-label">Or Paste Content</label>
                        <textarea id="jsonPasteArea" class="textarea-control" rows="3" placeholder="Paste JSON or XML..."></textarea>
                    </div>
                    <button class="btn btn-secondary" id="loadPasteBtn" style="width: 100%;">Load Text</button>
                    
                    <!-- Download Buttons -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label class="form-label">Export</label>
                        <div class="btn-group">
                            <button class="btn btn-success" id="downloadJsonBtn" disabled>JSON</button>
                            <button class="btn btn-info" id="downloadXmlBtn" disabled>XML</button>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Operations Card (Hidden until load) -->
                <div class="card" id="bulk-ops-card" style="display: none;">
                    <h2 class="card-title">Bulk Edit</h2>
                    <div class="form-group">
                        <label class="form-label">Question Type</label>
                        <select id="bulk-edit-type" class="form-control">
                            <option value="all">All Types</option>
                            <option value="mcq">MCQ</option>
                            <option value="numerical">Numerical</option>
                            <option value="nested">Nested</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Set Marks To</label>
                        <input type="number" id="bulk-edit-marks" class="form-control" value="1" min="0">
                    </div>
                    <button class="btn btn-warning" id="bulk-edit-apply-btn" style="width: 100%;">Apply Marks</button>
                </div>
            </div>
            
            <!-- Content: Workspace -->
            <div class="content">
                
                <!-- Welcome Screen -->
                <div class="card" id="welcome-card">
                    <h2 class="card-title">Welcome</h2>
                    <p>This tool supports:</p>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: var(--secondary);">
                        <li><strong>Old JSON:</strong> Automatically converts `msq` and `multi_numerical` to `nested`.</li>
                        <li><strong>New JSON:</strong> Full support for `mcq`, `numerical`, and `nested`.</li>
                        <li><strong>Moodle XML:</strong> Import and Export support.</li>
                    </ul>
                </div>

                <!-- Results Workspace (Hidden by default) -->
                <div class="card" id="results-card" style="display: none;">
                    <h2 class="card-title" id="workspace-title">Workspace</h2>
                    
                    <!-- Statistics -->
                    <div class="stats-grid" id="stats-grid"></div>
                    
                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab active" data-tab="preview">Preview & Edit</button>
                        <button class="tab" data-tab="raw">Raw Output</button>
                    </div>
                    
                    <!-- Tab: Preview -->
                    <div class="tab-content active" id="preview-tab">
                        <div id="questions-container"></div>
                    </div>

                    <!-- Tab: Raw Code -->
                    <div class="tab-content" id="raw-tab">
                        <div class="btn-group" style="margin-bottom: 1rem;">
                             <button class="btn btn-warning" id="convertBtn">Switch Format (JSON/XML)</button>
                            <button class="btn btn-info" id="copyRawBtn">Copy Code</button>
                        </div>
                        <div class="code-output" id="raw-output"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Question</h3>
                <button class="btn btn-icon btn-light" onclick="closeEditModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-index">
                    <input type="hidden" id="edit-type">
                    
                    <div class="form-group">
                        <label class="form-label">Question Text</label>
                        <textarea class="textarea-control" id="edit-question" rows="3"></textarea>
                    </div>
                    
                    <!-- Dynamic Editor Fields -->
                    <div id="mcq-editor-fields" style="display:none;">
                        <label class="form-label">Options</label>
                        <div id="edit-options"></div>
                        <button type="button" class="btn btn-light btn-sm" onclick="addOption()" style="margin-top:0.5rem;">+ Add Option</button>
                    </div>

                    <div id="numerical-editor-fields" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">Correct Answer (Number)</label>
                            <input type="number" step="any" class="form-control" id="edit-correct-answer">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Entry Instructions</label>
                            <input type="text" class="form-control" id="edit-entry-instructions">
                        </div>
                    </div>

                    <div id="nested-editor-fields" style="display:none;">
                        <div class="alert alert-info">Nested questions are complex. Please edit the structure in the source file or use Raw Mode if you need to add/remove sub-questions.</div>
                    </div>

                    <div class="form-group" style="margin-top:1rem;">
                        <label class="form-label">Marks</label>
                        <input type="number" class="form-control" id="edit-marks" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Explanation</label>
                        <textarea class="textarea-control" id="edit-explanation" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    <div id="alert-container"></div>

    <script>
        // --- STATE ---
        let editedData = null;
        let pendingData = null;
        let currentRawFormat = 'json';

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('fileInput');
        const fileDropZone = document.getElementById('fileDropZone');
        const resultsCard = document.getElementById('results-card');
        const welcomeCard = document.getElementById('welcome-card');
        const questionsContainer = document.getElementById('questions-container');
        const rawOutput = document.getElementById('raw-output');
        const editModal = document.getElementById('edit-modal');
        const alertContainer = document.getElementById('alert-container');
        const statsGrid = document.getElementById('stats-grid');
        const downloadJsonBtn = document.getElementById('downloadJsonBtn');
        const downloadXmlBtn = document.getElementById('downloadXmlBtn');
        const workspaceTitle = document.getElementById('workspace-title');
        const bulkOpsCard = document.getElementById('bulk-ops-card');
        const dataPreview = document.getElementById('dataPreview');
        const previewContent = document.getElementById('previewContent');
        const confirmLoadBtn = document.getElementById('confirmLoadBtn');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fileInput.addEventListener('change', handleFileLoad);
            document.getElementById('loadPasteBtn').addEventListener('click', handlePasteLoad);
            confirmLoadBtn.addEventListener('click', confirmLoad);
            
            // Drag & Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                fileDropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }, false);
            });
            fileDropZone.addEventListener('dragover', () => fileDropZone.style.borderColor = 'var(--primary)');
            fileDropZone.addEventListener('dragleave', () => fileDropZone.style.borderColor = 'var(--border)');
            fileDropZone.addEventListener('drop', handleDrop);

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });

            // Actions
            downloadJsonBtn.addEventListener('click', () => downloadFile('json'));
            downloadXmlBtn.addEventListener('click', () => downloadFile('xml'));
            document.getElementById('convertBtn').addEventListener('click', convertFormat);
            document.getElementById('copyRawBtn').addEventListener('click', copyToClipboard);
            document.getElementById('bulk-edit-apply-btn').addEventListener('click', handleBulkEditMarks);
            
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeEditModal(); });
        });

        // --- LOGIC ---

        function handleDrop(e) {
            fileDropZone.style.borderColor = 'var(--border)';
            const file = e.dataTransfer.files[0];
            if (file) readAndPreviewFile(file, file.name);
        }

        function handleFileLoad(e) {
            const file = e.target.files[0];
            if (file) readAndPreviewFile(file, file.name);
        }

        function handlePasteLoad() {
            const content = document.getElementById('jsonPasteArea').value;
            if (!content.trim()) return showAlert('Paste area is empty.', 'warning');
            const isXml = content.trim().startsWith('<quiz') || content.trim().startsWith('<?xml');
            showDataPreview(content, isXml ? 'pasted_data.xml' : 'pasted_data.json');
        }

        function readAndPreviewFile(file, fileName) {
            const reader = new FileReader();
            reader.onload = (e) => showDataPreview(e.target.result, fileName);
            reader.onerror = () => showAlert('Error reading file.', 'error');
            reader.readAsText(file);
        }

        function showDataPreview(content, fileName) {
            let processedData;
            let title = fileName;
            let previewHtml = '';
            let isXml = fileName.toLowerCase().endsWith('.xml') || content.trim().startsWith('<?xml');

            try {
                if (isXml) {
                    processedData = parseMoodleXml(content);
                    title = `XML Set (${fileName})`;
                    previewHtml = `<p><strong>Format:</strong> Moodle XML</p><p><strong>Count:</strong> ${processedData.length}</p>`;
                } else {
                    const data = JSON.parse(content);
                    if (!Array.isArray(data) && data.questions && data.markScheme) {
                        const q = data.questions[0];
                        q.questionType = 'financial'; 
                        q.markScheme = data.markScheme;
                        q.examTitle = data.examTitle;
                        processedData = [q];
                        previewHtml = `<p><strong>Format:</strong> Complex Financial Object</p>`;
                    } else if (Array.isArray(data)) {
                        processedData = data;
                        previewHtml = `<p><strong>Format:</strong> JSON Array</p><p><strong>Count:</strong> ${data.length}</p>`;
                    } else {
                        throw new Error("Unknown JSON structure");
                    }
                }

                // IMPORTANT: Normalize Old JSON to New JSON
                processedData = normalizeData(processedData);

                pendingData = { data: processedData, fileName, title };
                previewContent.innerHTML = previewHtml;
                dataPreview.style.display = 'block';

            } catch (error) {
                console.error(error);
                showAlert('Parse Error: ' + error.message, 'error');
            }
        }

        function confirmLoad() {
            if (!pendingData) return;
            editedData = pendingData.data;
            workspaceTitle.textContent = `Editing ${pendingData.title}`;
            displayResults(editedData, 'json');
            
            // UI Transitions
            welcomeCard.style.display = 'none';
            resultsCard.style.display = 'block';
            bulkOpsCard.style.display = 'block';
            downloadJsonBtn.disabled = false;
            downloadXmlBtn.disabled = false;
            dataPreview.style.display = 'none';
            showAlert('Data loaded!', 'success');
        }

        /**
         * CORE FUNCTION: Converts Old Schema (MSQ, Multi-Num) to New Schema (Nested).
         */
        function normalizeData(data) {
            return data.map(q => {
                if (!q.id) q.id = `Q-${Math.random().toString(36).substr(2, 5)}`;
                
                // Convert MSQ -> Nested
                if (q.questionType === 'msq') {
                    return {
                        ...q,
                        questionType: 'nested',
                        subQuestions: (q.subQuestions || []).map(sq => {
                            // Normalize options to Title Case if they are booleans to ensure matching
                            let opts = sq.availableOptions || ["True", "False"];
                            let ans = sq.correctOption;
                            
                            // Simple fix for boolean mismatch (True vs true)
                            if (String(ans).toLowerCase() === 'true') ans = "True";
                            if (String(ans).toLowerCase() === 'false') ans = "False";

                            return {
                                type: 'mcq',
                                text: sq.statement,
                                options: opts,
                                answer: ans,
                                marks: sq.marks || 1
                            };
                        })
                    };
                }

                // Convert Multi-Numerical -> Nested
                if (q.questionType === 'multi_numerical') {
                    return {
                        ...q,
                        questionType: 'nested',
                        subQuestions: (q.subQuestions || []).map(sq => ({
                            type: 'numerical',
                            text: sq.text,
                            answer: sq.answer,
                            marks: sq.marks || 1
                        }))
                    };
                }

                return q;
            });
        }

        function parseMoodleXml(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            if (xmlDoc.querySelector('parsererror')) throw new Error("Invalid XML");

            const questions = [];
            xmlDoc.querySelectorAll('question').forEach(qNode => {
                const type = qNode.getAttribute('type');
                const name = qNode.querySelector('name text')?.textContent || 'Untitled';
                const textHtml = qNode.querySelector('questiontext text')?.textContent || '';
                const feedback = qNode.querySelector('generalfeedback text')?.textContent || '';
                const grade = parseFloat(qNode.querySelector('defaultgrade')?.textContent || 1);

                let qData = { id: name, marks: grade, questionText: textHtml, explanation: feedback };

                if (type === 'multichoice') {
                    qData.questionType = 'mcq';
                    qData.options = [];
                    qData.correctOptions = [];
                    qNode.querySelectorAll('answer').forEach((a, i) => {
                        qData.options.push(a.querySelector('text')?.textContent || '');
                        if (parseFloat(a.getAttribute('fraction')) > 0) qData.correctOptions.push(i);
                    });
                    qData.questionText = qData.questionText.replace(/<\/?p>/g, '');
                } else if (type === 'cloze') {
                    const numMatch = textHtml.match(/\{(\d+):NUMERICAL:=([\d.-]+)(:[\d.]*)?\}/);
                    const clozeCount = (textHtml.match(/\{.*?\}/g) || []).length;

                    if (clozeCount === 1 && numMatch && !textHtml.includes('table')) {
                        qData.questionType = 'numerical';
                        qData.correctAnswer = parseFloat(numMatch[2]);
                        qData.questionText = textHtml.replace(/\{.*?\}/, '').replace(/<\/?p>/g, '').replace('Answer:', '').trim();
                        qData.marks = parseInt(numMatch[1]);
                    } else if (textHtml.includes('table') && (textHtml.includes('Statement of') || textHtml.includes('Balance Sheet'))) {
                        qData.questionType = 'financial';
                        qData.rawXml = qNode.outerHTML; 
                        qData.title = name;
                    } else {
                        qData.questionType = 'nested';
                        qData.subQuestions = []; // Empty means it relies on textHtml for the cloze codes
                    }
                }
                questions.push(qData);
            });
            return questions;
        }

        function displayResults(data, rawFormat) {
            currentRawFormat = rawFormat;
            updateStats(data);
            displayQuestions(data);
            
            rawOutput.textContent = rawFormat === 'json' 
                ? JSON.stringify(data, null, 2) 
                : generateXml(data);
                
            document.getElementById('convertBtn').textContent = 
                rawFormat === 'json' ? 'Switch to XML View' : 'Switch to JSON View';
        }

        function updateStats(data) {
            const counts = { mcq:0, numerical:0, nested:0, financial:0, total: data.length };
            let totalMarks = 0;
            data.forEach(q => {
                counts[q.questionType] = (counts[q.questionType] || 0) + 1;
                totalMarks += (q.marks || 0);
            });

            statsGrid.innerHTML = `
                <div class="stat-card"><div class="stat-value">${counts.total}</div><div class="stat-label">Questions</div></div>
                <div class="stat-card"><div class="stat-value">${totalMarks}</div><div class="stat-label">Marks</div></div>
                <div class="stat-card"><div class="stat-value">${counts.mcq}</div><div class="stat-label">MCQ</div></div>
                <div class="stat-card"><div class="stat-value">${counts.nested}</div><div class="stat-label">Nested</div></div>
            `;
        }

        function displayQuestions(data) {
            questionsContainer.innerHTML = '';
            data.forEach((q, i) => {
                const el = document.createElement('div');
                el.className = 'question-card';
                
                let content = '';
                
                if (q.questionType === 'mcq') {
                    content = `<div class="options-list">
                        ${(q.options || []).map((opt, idx) => `
                            <div class="option-item ${(q.correctOptions||[]).includes(idx)?'correct':''}">
                                <div class="option-letter">${String.fromCharCode(65+idx)}</div>
                                <div>${opt}</div>
                            </div>
                        `).join('')}
                    </div>`;
                }
                else if (q.questionType === 'numerical') {
                    content = `<div class="explanation-box" style="background:#ecfdf5; border-color:var(--success);">
                        <strong>Correct Answer:</strong> ${q.correctAnswer}
                        ${q.entryInstructions ? `<br><small>${q.entryInstructions}</small>` : ''}
                    </div>`;
                }
                else if (q.questionType === 'nested') {
                    content = `<div class="sub-questions-container"><h5>Sub-Questions:</h5>`;
                    if (q.subQuestions && q.subQuestions.length > 0) {
                        q.subQuestions.forEach(sq => {
                            content += `<div class="sub-question-card">
                                <strong>${sq.type.toUpperCase()}:</strong> ${sq.text} 
                                <span class="tag" style="float:right; font-size:0.8em;">${sq.marks}mk</span>
                                <br>
                                <span style="color:var(--success); font-weight:bold;">Ans: ${sq.answer}</span>
                            </div>`;
                        });
                    } else {
                        content += `<em>Embedded in text (Cloze format)</em>`;
                    }
                    content += `</div>`;
                }
                else if (q.questionType === 'financial') {
                     content = `<div class="alert alert-info">Complex Financial Question (Read-Only)</div>`;
                }

                el.innerHTML = `
                    <div class="question-header">
                        <span style="font-weight:bold; color:var(--secondary);">${q.id}</span>
                        <div>
                            <button class="btn btn-icon btn-info" onclick="openEdit(${i})">‚úèÔ∏è</button>
                            <button class="btn btn-icon btn-danger" onclick="deleteQ(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="margin-bottom:1rem;">
                        <span class="tag">${q.questionType}</span>
                        <span class="tag">${q.marks} Marks</span>
                    </div>
                    <div style="margin-bottom:1rem;">${q.questionText || q.title || ''}</div>
                    ${content}
                    ${q.explanation ? `<div class="explanation-box"><span style="font-weight:bold;">Explanation:</span> ${q.explanation}</div>` : ''}
                `;
                questionsContainer.appendChild(el);
            });
        }

        function openEdit(index) {
            const q = editedData[index];
            if (q.questionType === 'financial' && q.rawXml) return showAlert('Cannot edit raw XML questions.', 'warning');
            
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-type').value = q.questionType;
            document.getElementById('edit-question').value = q.questionText || '';
            document.getElementById('edit-explanation').value = q.explanation || '';
            document.getElementById('edit-marks').value = q.marks || 1;
            document.getElementById('modal-title').textContent = `Edit ${q.questionType.toUpperCase()}`;

            const types = ['mcq', 'numerical', 'nested'];
            types.forEach(t => document.getElementById(`${t}-editor-fields`).style.display = 'none');
            if(types.includes(q.questionType)) document.getElementById(`${q.questionType}-editor-fields`).style.display = 'block';

            if (q.questionType === 'mcq') renderMcqEditor(q);
            if (q.questionType === 'numerical') {
                document.getElementById('edit-correct-answer').value = q.correctAnswer;
                document.getElementById('edit-entry-instructions').value = q.entryInstructions || '';
            }

            editModal.classList.add('active');
        }

        function renderMcqEditor(q) {
            const container = document.getElementById('edit-options');
            container.innerHTML = '';
            (q.options || []).forEach((opt, i) => {
                const isChecked = (q.correctOptions||[]).includes(i);
                container.innerHTML += `
                    <div class="option-editor">
                        <div class="radio-label">
                            <input type="checkbox" class="mcq-check" value="${i}" ${isChecked?'checked':''}> Correct Answer
                        </div>
                        <textarea class="textarea-control mcq-text" rows="2">${opt}</textarea>
                    </div>`;
            });
        }

        function addOption() {
            const container = document.getElementById('edit-options');
            container.innerHTML += `
                <div class="option-editor">
                     <div class="radio-label"><input type="checkbox" class="mcq-check"> Correct Answer</div>
                    <textarea class="textarea-control mcq-text" rows="2"></textarea>
                </div>`;
        }

        function saveEdit() {
            const index = document.getElementById('edit-index').value;
            const q = editedData[index];
            
            q.questionText = document.getElementById('edit-question').value;
            q.explanation = document.getElementById('edit-explanation').value;
            q.marks = parseFloat(document.getElementById('edit-marks').value);

            if (q.questionType === 'mcq') {
                q.options = [];
                q.correctOptions = [];
                document.querySelectorAll('#edit-options .option-editor').forEach((el, i) => {
                    q.options.push(el.querySelector('.mcq-text').value);
                    if (el.querySelector('.mcq-check').checked) q.correctOptions.push(i);
                });
            } else if (q.questionType === 'numerical') {
                q.correctAnswer = parseFloat(document.getElementById('edit-correct-answer').value);
                q.entryInstructions = document.getElementById('edit-entry-instructions').value;
            }

            closeEditModal();
            displayResults(editedData, currentRawFormat);
            showAlert('Saved!', 'success');
        }

        function deleteQ(index) {
            if(confirm('Delete this question?')) {
                editedData.splice(index, 1);
                displayResults(editedData, currentRawFormat);
            }
        }

        function closeEditModal() { editModal.classList.remove('active'); }

        function handleBulkEditMarks() {
            const type = document.getElementById('bulk-edit-type').value;
            const marks = parseFloat(document.getElementById('bulk-edit-marks').value);
            if (isNaN(marks)) return;
            
            let count = 0;
            editedData.forEach(q => {
                if (type === 'all' || q.questionType === type) {
                    q.marks = marks;
                    if (q.questionType === 'financial' && q.rawXml) {
                         q.rawXml = q.rawXml.replace(/<defaultgrade>.*?<\/defaultgrade>/, `<defaultgrade>${marks.toFixed(2)}</defaultgrade>`);
                    }
                    count++;
                }
            });
            displayResults(editedData, currentRawFormat);
            showAlert(`Updated ${count} questions.`, 'success');
        }

        function generateXml(data) {
            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<quiz>\n`;
            data.forEach(q => {
                if (q.questionType === 'mcq') xml += _genMcq(q);
                else if (q.questionType === 'numerical') xml += _genNum(q);
                else if (q.questionType === 'nested') xml += _genNested(q);
                else if (q.questionType === 'financial') xml += (q.rawXml || ''); 
            });
            xml += `</quiz>`;
            return xml;
        }

        // Helper to escape special Cloze characters that break Moodle
function _escapeCloze(str) {
    if (!str) return '';
    return String(str)
        .replace(/\\/g, '\\\\') // Escape backslashes first
        .replace(/~/g, '\\~')   // Separator
        .replace(/=/g, '\\=')   // Correct answer marker
        .replace(/#/g, '\\#')   // Feedback marker
        .replace(/\{/g, '\\{')  // Open brace
        .replace(/\}/g, '\\}')  // Close brace
        .replace(/:/g, '\\:');  // Colon (sometimes causes issues in keys)
}

        function _genMcq(q) {
            const isMulti = q.correctOptions.length > 1;
            const fraction = isMulti ? (100/q.correctOptions.length).toFixed(5) : 100;
            
            let xml = `  <question type="multichoice">\n`;
            xml += `    <name><text>${q.id}</text></name>\n`;
            xml += `    <questiontext format="html"><text><![CDATA[<p>${q.questionText}</p>]]></text></questiontext>\n`;
            xml += `    <generalfeedback format="html"><text><![CDATA[<p>${q.explanation}</p>]]></text></generalfeedback>\n`;
            xml += `    <defaultgrade>${q.marks}</defaultgrade>\n    <single>${!isMulti}</single>\n    <shuffleanswers>true</shuffleanswers>\n`;
            q.options.forEach((opt, i) => {
                const isCor = q.correctOptions.includes(i);
                xml += `    <answer fraction="${isCor ? fraction : 0}" format="html"><text><![CDATA[${opt}]]></text></answer>\n`;
            });
            xml += `  </question>\n`;
            return xml;
        }

        function _genNum(q) {
            const html = `<p>${q.questionText}</p><p>Answer: {${q.marks}:NUMERICAL:=${q.correctAnswer}:0}</p>`;
            return _genClozeShell(q, html);
        }

        function _genNested(q) {
    let html = `<p>${q.questionText}</p>`;
    
    if (q.subQuestions && q.subQuestions.length > 0) {
        // Detect if we should use a list or inline (simple heuristic)
        const useList = q.subQuestions.length > 1; 
        if (useList) html += `<ul>`;

        q.subQuestions.forEach(sq => {
            if (useList) html += `<li>`;
            
            // Add the sub-question text if it exists
            if (sq.text) html += `${sq.text} `;

            if (sq.type === 'numerical') {
                // NUMERICAL LOGIC
                // Ensure we have a valid number, default to 0 if missing
                const val = sq.answer !== undefined && sq.answer !== null ? sq.answer : 0;
                // :0 sets tolerance to 0. Add tolerance if needed (e.g. :0.1)
                html += `{${sq.marks}:NUMERICAL:=${val}:0}`;
            
            } else if (sq.type === 'mcq') {
    // MULTICHOICE LOGIC
    
    let options = sq.options || [];
    if (options.length < 2) {
        if (options.length === 0) options = ["True", "False"];
        else options.push("Other"); 
    }

    const cleanAns = String(sq.answer).trim().toLowerCase();
    
    let foundCorrect = false;

    // --- CHANGED SECTION START ---
    let optsString = options.map(o => {
        const cleanOpt = String(o).trim().toLowerCase();
        const isMatch = cleanOpt === cleanAns;
        
        if (isMatch) foundCorrect = true;
        
        // LOGIC CHANGE: 
        // Always start with '~'
        // Then add '=' only if it is a match
        // Then add the escaped text
        return '~' + (isMatch ? '=' : '') + _escapeCloze(o);
    }).join('');
    // --- CHANGED SECTION END ---

    // 3. Emergency Fallback
    if (!foundCorrect) {
        console.warn(`No matching answer found for nested Q: "${sq.text}". Defaulting first option to correct.`);
        
        // --- CHANGED FALLBACK SECTION START ---
        optsString = options.map((o, index) => {
            // Apply the same logic: Always '~', add '=' if it's the first index (forced correct)
            return '~' + (index === 0 ? '=' : '') + _escapeCloze(o);
        }).join('');
        // --- CHANGED FALLBACK SECTION END ---
    }

    html += `{${sq.marks}:MCH:${optsString}}`;
}

            if (useList) html += `</li>`;
            else html += `<br/>`; // Line break if not using list
        });

        if (useList) html += `</ul>`;
    }
    
    return _genClozeShell(q, html);
}

        function _genClozeShell(q, htmlContent) {
            return `  <question type="cloze">\n` +
                   `    <name><text>${q.id}</text></name>\n` +
                   `    <questiontext format="html"><text><![CDATA[${htmlContent}]]></text></questiontext>\n` +
                   `    <generalfeedback format="html"><text><![CDATA[<p>${q.explanation}</p>]]></text></generalfeedback>\n` +
                   `    <defaultgrade>${q.marks}</defaultgrade>\n` +
                   `  </question>\n`;
        }

        function convertFormat() {
            if (!editedData) return;
            const next = currentRawFormat === 'json' ? 'xml' : 'json';
            displayResults(editedData, next);
            showAlert(`Converted to ${next.toUpperCase()}`, 'info');
        }

        function copyToClipboard() {
             navigator.clipboard.writeText(rawOutput.textContent)
                .then(() => showAlert('Copied!', 'success'))
                .catch(() => showAlert('Copy failed', 'error'));
        }

        function showAlert(msg, type) {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 3000);
        }

        function downloadFile(ext) {
            if (!editedData) return;
            let name = prompt("Filename:", "questions");
            if (!name) return;
            if (!name.endsWith('.'+ext)) name += '.'+ext;
            
            const content = ext === 'json' ? JSON.stringify(editedData,null,2) : generateXml(editedData);
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>