<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChiaSeed - Question Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            background: var(--gradient);
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 40px var(--shadow);
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px var(--shadow);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--gradient);
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.25);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.35);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-light {
            background: var(--light);
            color: var(--dark);
            border: 2px solid var(--border);
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: var(--primary);
            background: var(--light);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.05));
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question-preview {
            background: var(--light);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .question-preview:hover {
            background: white;
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .question-number {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .question-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .question-text {
            font-size: 1.05rem;
            margin-bottom: 1rem;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .options-list {
            margin-left: 1rem;
            margin-bottom: 1rem;
        }
        
        .option-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .option-item.correct {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }
        
        .option-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .option-letter {
            width: 30px;
            height: 30px;
            background: var(--gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .option-item.correct .option-letter {
            background: var(--success);
        }
        
        .explanation-box {
            background: rgba(99, 102, 241, 0.05);
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .explanation-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .edit-modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: var(--gradient);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem 1rem 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .textarea-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }
        
        .textarea-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .option-editor {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 0.5rem;
        }
        
        .option-editor-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid var(--info);
            color: var(--info);
        }
        
        .footer {
            margin-top: 3rem;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .footer p {
            margin-bottom: 0.5rem;
            color: #6b7280;
        }
        
        .footer strong {
            color: var(--primary);
        }
        
        .code-output {
            background: #1f2937;
            color: #10b981;
            padding: 1.5rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üå± ChiaSeed Question Editor</h1>
            <p>Load, Edit, and Export Educational Questions with Ease</p>
        </div>
    </div>
    
    <div class="container">
        <div class="main-grid">
            <div class="sidebar">
                <div class="card">
                    <h2 class="card-title">File Operations</h2>
                    <div class="form-group">
                        <label class="form-label" for="fileInput">Load JSON File</label>
                        <input type="file" id="fileInput" class="form-control" accept=".json">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Download Edited Questions</label>
                        <div class="btn-group">
                            <button class="btn btn-success" id="downloadJsonBtn" disabled>
                                <span>‚¨áÔ∏è</span> Download JSON
                            </button>
                            <button class="btn btn-info" id="downloadXmlBtn" disabled>
                                <span>‚¨áÔ∏è</span> Download XML
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div class="card" id="results-card" style="display: none;">
                    <h2 class="card-title">Editing Workspace</h2>
                    
                    <div class="stats-grid" id="stats-grid"></div>
                    
                    <div class="tabs" id="tabs">
                        <button class="tab active" data-tab="preview">üìù Preview & Edit</button>
                        <button class="tab" data-tab="analytics">üìä Analytics</button>
                        <button class="tab" data-tab="raw">üíª Raw Output</button>
                    </div>
                    
                    <div class="tab-content active" id="preview-tab">
                        <div id="alert-container"></div>
                        <div id="questions-container"></div>
                    </div>

                    <div class="tab-content" id="analytics-tab">
                        </div>
                    
                    <div class="tab-content" id="raw-tab">
                        <div class="btn-group" style="margin-bottom: 1.5rem;">
                             <button class="btn btn-warning" id="convertBtn">
                                <span>üîÑ</span> Convert to XML
                            </button>
                            <button class="btn btn-info" id="copyRawBtn">
                                <span>üìã</span> Copy to Clipboard
                            </button>
                        </div>
                        <div class="code-output" id="raw-output"></div>
                    </div>
                </div>
                
                <div class="card" id="welcome-card">
                    <h2 class="card-title">Welcome to the ChiaSeed Editor</h2>
                    <p style="margin-bottom: 1rem;">This tool allows you to load a question bank in JSON format, edit individual questions, and export the results as either JSON or Moodle XML.</p>
                    
                    <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary);">üìö How to Use</h3>
                    <ol style="padding-left: 1.5rem; line-height: 1.8;">
                        <li>Click the "Browse" or "Choose File" button to select a <code>.json</code> file.</li>
                        <li>The questions will appear in the "Preview & Edit" tab.</li>
                        <li>An "Analytics" tab will show a breakdown of the question set.</li>
                        <li>Click the ‚úèÔ∏è icon to edit a question or üóëÔ∏è to delete it.</li>
                        <li>Use the "Raw Output" tab to view and copy the data.</li>
                        <li>Use the "Download" buttons on the left to save your edited file.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p><strong>ChiaSeed</strong> - Developed by <strong>Tyno Chi</strong> & <strong>code002xcode016</strong></p>
        <p>For all world prize winner students! üèÜ</p>
        <p style="margin-top: 1rem;">Special Thanks to Our Amazing Lecturers for guiding us all üôè</p>
    </div>
    
    <div class="edit-modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-size: 1.5rem;">Edit Question</h3>
                <button class="btn btn-icon btn-light" onclick="closeEditModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-index">
                    
                    <div class="form-group">
                        <label class="form-label">Question Text</label>
                        <textarea class="textarea-control" id="edit-question" rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Options</label>
                        <div id="edit-options"></div>
                        <button type="button" class="btn btn-light" onclick="addOption()">
                            <span>‚ûï</span> Add Option
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Explanation</label>
                        <textarea class="textarea-control" id="edit-explanation" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">
                    <span>üíæ</span> Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // State Management
        let editedData = null;
        let currentRawFormat = 'json';
        
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const resultsCard = document.getElementById('results-card');
        const welcomeCard = document.getElementById('welcome-card');
        const questionsContainer = document.getElementById('questions-container');
        const rawOutput = document.getElementById('raw-output');
        const editModal = document.getElementById('edit-modal');
        const alertContainer = document.getElementById('alert-container');
        const statsGrid = document.getElementById('stats-grid');
        const downloadJsonBtn = document.getElementById('downloadJsonBtn');
        const downloadXmlBtn = document.getElementById('downloadXmlBtn');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', setupEventListeners);
        
        function setupEventListeners() {
            fileInput.addEventListener('change', handleFileLoad);
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });
            
            // Action buttons
            downloadJsonBtn.addEventListener('click', () => downloadFile('json'));
            downloadXmlBtn.addEventListener('click', () => downloadFile('xml'));
            document.getElementById('convertBtn')?.addEventListener('click', convertFormat);
            document.getElementById('copyRawBtn')?.addEventListener('click', copyToClipboard);
        }
        
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Validate data structure
                    if (data && Array.isArray(data.entries)) {
                        editedData = data; // Store the loaded data
                        displayResults(editedData, 'json');
                        welcomeCard.style.display = 'none';
                        resultsCard.style.display = 'block';
                        downloadJsonBtn.disabled = false;
                        downloadXmlBtn.disabled = false;
                        showAlert('JSON file loaded successfully!', 'success');
                    } else {
                        throw new Error("Invalid JSON structure. Must have an 'entries' array.");
                    }
                } catch (error) {
                    // MODIFIED: Added console.error for better debugging
                    console.error("Error parsing or processing JSON file:", error);
                    showAlert('Failed to load file: ' + error.message, 'error');
                    welcomeCard.style.display = 'block';
                    resultsCard.style.display = 'none';
                    downloadJsonBtn.disabled = true;
                    downloadXmlBtn.disabled = true;
                }
            };
            reader.onerror = () => {
                showAlert('Error reading the file.', 'error');
            };
            reader.readAsText(file);
        }

        // NEW: Function to perform detailed analysis of the question data
        function runAnalytics(data) {
            if (!data || !Array.isArray(data.entries)) {
                throw new Error("Invalid data structure for analytics.");
            }
            const analytics = {
                totalQuestions: data.entries.length,
                questionTypeCounts: {},
                questionsWithoutExplanation: 0,
                multiAnswerCount: 0,
                optionCountDistribution: {},
                averageOptions: 0,
            };

            let totalOptions = 0;

            data.entries.forEach(q => {
                // Question Type Count
                const type = q.type || 'MCQ'; // Default to MCQ if type is not specified
                analytics.questionTypeCounts[type] = (analytics.questionTypeCounts[type] || 0) + 1;

                // Missing Explanation Count
                if (!q.explanation && !q.answer_explanation) {
                    analytics.questionsWithoutExplanation++;
                }

                // Multi-Answer Count
                if (q.answer && q.answer.length > 1) {
                    analytics.multiAnswerCount++;
                }

                // Option Count Distribution
                const numOptions = q.options ? q.options.length : 0;
                analytics.optionCountDistribution[numOptions] = (analytics.optionCountDistribution[numOptions] || 0) + 1;
                totalOptions += numOptions;
            });
            
            if (analytics.totalQuestions > 0) {
                analytics.averageOptions = (totalOptions / analytics.totalQuestions).toFixed(2);
            }

            return analytics;
        }

        // NEW: Function to display the detailed analytics in the UI
        function displayAnalytics(analytics) {
            const container = document.getElementById('analytics-tab');
            if (!container) return;
            
            let typeDistributionHtml = '';
            const sortedTypes = Object.entries(analytics.questionTypeCounts).sort((a, b) => b[1] - a[1]);
            for (const [type, count] of sortedTypes) {
                typeDistributionHtml += `<li style="padding: 0.25rem 0;"><strong>${type}:</strong> ${count} questions</li>`;
            }

            let optionDistributionHtml = '';
            const sortedOptions = Object.entries(analytics.optionCountDistribution).sort((a, b) => Number(a[0]) - Number(b[0]));
            for (const [count, numQuestions] of sortedOptions) {
                optionDistributionHtml += `<li style="padding: 0.25rem 0;"><strong>${count} Options:</strong> ${numQuestions} question${numQuestions > 1 ? 's' : ''}</li>`;
            }

            container.innerHTML = `
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title">üìä Content Analysis</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">Total Questions: <strong>${analytics.totalQuestions}</strong></li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">Multi-Answer Questions: <strong>${analytics.multiAnswerCount}</strong></li>
                        <li style="padding: 0.5rem 0;">Questions without Explanation: <strong>${analytics.questionsWithoutExplanation}</strong></li>
                    </ul>
                </div>
                
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title">üìã Question Type Distribution</h3>
                    <ul style="padding-left: 1.5rem;">${typeDistributionHtml || '<li>No types found.</li>'}</ul>
                </div>
                
                <div class="card">
                    <h3 class="card-title">üî¢ Option Count Distribution</h3>
                    <ul style="padding-left: 1.5rem;">${optionDistributionHtml || '<li>No options found.</li>'}</ul>
                </div>
            `;
        }
        
        function displayResults(data, rawFormat) {
            currentRawFormat = rawFormat;
            
            // MODIFIED: Run analytics and update all relevant UI parts
            try {
                const analytics = runAnalytics(data);
                updateStatistics(analytics); // Update top-level stats
                displayAnalytics(analytics); // Update detailed analytics tab
            } catch (error) {
                console.error("Failed to generate analytics:", error);
                showAlert("Could not generate analytics: " + error.message, 'error');
            }
            
            // Display questions in preview
            displayQuestions(data);
            
            // Display raw output
            const rawContent = rawFormat === 'json' ? 
                JSON.stringify(data, null, 2) : 
                generateMoodleXml(data);
            rawOutput.textContent = rawContent;
            
            // Update button states
            document.getElementById('convertBtn').textContent = rawFormat === 'json' ? 
                'üîÑ Convert to XML' : 'üîÑ Convert to JSON';
        }
        
        // MODIFIED: Function now accepts the pre-calculated analytics object
        function updateStatistics(analytics) {
            const totalQuestions = analytics.totalQuestions;
            const questionTypesCount = Object.keys(analytics.questionTypeCounts).length;
            const averageOptions = analytics.averageOptions;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalQuestions}</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${questionTypesCount}</div>
                    <div class="stat-label">Question Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${averageOptions}</div>
                    <div class="stat-label">Avg. Options</div>
                </div>
            `;
        }
        
        function displayQuestions(data) {
            questionsContainer.innerHTML = '';
            
            if (!data.entries || data.entries.length === 0) {
                questionsContainer.innerHTML = '<div class="alert alert-info">No questions to display.</div>';
                return;
            }

            data.entries.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-preview';
                const questionText = question.questions || question.question || question.text || '[No Question Text Found]';

                questionDiv.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Question ${index + 1}</div>
                        <div class="question-actions">
                            <button class="btn btn-icon btn-info" onclick="editQuestion(${index})" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-icon btn-danger" onclick="deleteQuestion(${index})" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="question-text">${questionText}</div>
                    ${question.options ? `
                    <div class="options-list">
                        ${question.options.map((option, i) => `
                            <div class="option-item ${(question.answer || []).includes(i) ? 'correct' : ''}">
                                <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                                <div>${option}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    ${question.explanation || question.answer_explanation ? `
                    <div class="explanation-box">
                        <div class="explanation-label">
                            <span>üí°</span> Explanation
                        </div>
                        <div>${question.explanation || question.answer_explanation || ''}</div>
                    </div>
                    ` : ''}
                `;
                questionsContainer.appendChild(questionDiv);
            });
        }
        
        function deleteQuestion(index) {
            if (confirm('Are you sure you want to delete this question?')) {
                editedData.entries.splice(index, 1);
                displayResults(editedData, currentRawFormat);
                showAlert('Question deleted successfully.', 'info');
            }
        }

        function editQuestion(index) {
            const question = editedData.entries[index];
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-question').value = question.questions || question.question || question.text || '';
            document.getElementById('edit-explanation').value = question.explanation || question.answer_explanation || '';
            
            const optionsContainer = document.getElementById('edit-options');
            optionsContainer.innerHTML = '';
            
            (question.options || []).forEach((opt, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-editor';
                optionDiv.innerHTML = `
                    <div class="option-editor-header">
                        <label class="radio-label">
                            <input type="checkbox" name="edit-answer" value="${i}" ${(question.answer || []).includes(i) ? 'checked' : ''}>
                            Correct Answer
                        </label>
                    </div>
                    <textarea class="textarea-control" rows="2">${opt}</textarea>
                `;
                optionsContainer.appendChild(optionDiv);
            });
            
            editModal.classList.add('active');
        }
        function closeEditModal() {
            editModal.classList.remove('active');
        }
        
        function addOption() {
            const optionsContainer = document.getElementById('edit-options');
            const optionIndex = optionsContainer.children.length;
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-editor';
            optionDiv.innerHTML = `
                <div class="option-editor-header">
                    <label class="radio-label">
                        <input type="checkbox" name="edit-answer" value="${optionIndex}">
                        Correct Answer
                    </label>
                </div>
                <textarea class="textarea-control" rows="2"></textarea>
            `;
            optionsContainer.appendChild(optionDiv);
        }

        function saveEdit() {
            const index = document.getElementById('edit-index').value;
            const questionText = document.getElementById('edit-question').value;
            const explanationText = document.getElementById('edit-explanation').value;
        
            const options = [];
            const answers = [];
        
            document.querySelectorAll('#edit-options .option-editor').forEach((editor) => {
                const optionText = editor.querySelector('textarea').value;
                if (optionText.trim()) {
                    options.push(optionText);
                    if (editor.querySelector('input[name="edit-answer"]').checked) {
                        answers.push(options.length - 1);
                    }
                }
            });
        
            editedData.entries[index] = {
                ...editedData.entries[index],
                question: questionText,
                text: questionText,
                questions: questionText, // Ensure all possible keys are updated
                options: options,
                answer: answers,
                explanation: explanationText,
                answer_explanation: explanationText // Ensure all possible keys are updated
            };
        
            closeEditModal();
            displayResults(editedData, currentRawFormat);
            showAlert('Question updated successfully.', 'success');
        }
        
        function showAlert(message, type = 'info', duration = 5000) {
            alertContainer.innerHTML = ''; // Clear previous alerts
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, duration);
        }
        
        function copyToClipboard() {
            const text = rawOutput.textContent;
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Copied to clipboard!', 'success');
            }, (err) => {
                showAlert('Failed to copy: ' + err, 'error');
            });
        }
        
        function convertFormat() {
            const newFormat = currentRawFormat === 'json' ? 'xml' : 'json';
            displayResults(editedData, newFormat);
            showAlert(`Raw output converted to ${newFormat.toUpperCase()}`, 'info');
        }
        
        function downloadFile(format) {
            const content = format === 'json' ? 
                JSON.stringify(editedData, null, 2) : 
                generateMoodleXml(editedData);

            const blob = new Blob([content], { type: format === 'json' ? 'application/json' : 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `questions_edited.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function generateMoodleXml(data) {
            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<quiz>\n`;
            
            data.entries.forEach((q, index) => {
                const questionText = q.questions || q.question || q.text ||'';
                const isMulti = q.answer && q.answer.length > 1;
                const correctCount = (q.answer || []).length;
                const correctFraction = correctCount > 0 ? (100 / correctCount).toFixed(5) : 0;
                
                xml += `\n`;
                xml += `  <question type="multichoice">\n`;
                xml += `    <name><text>Question ${index + 1}</text></name>\n`;
                xml += `    <questiontext format="html">\n`;
                xml += `      <text><![CDATA[<p>${questionText}</p>]]></text>\n`;
                xml += `    </questiontext>\n`;
                xml += `    <generalfeedback format="html">\n`;
                xml += `      <text><![CDATA[<p>${q.explanation || q.answer_explanation || ''}</p>]]></text>\n`;
                xml += `    </generalfeedback>\n`;
                xml += `    <defaultgrade>1.0000000</defaultgrade>\n`;
                xml += `    <penalty>0</penalty>\n`;
                xml += `    <hidden>0</hidden>\n`;
                xml += `    <single>${!isMulti}</single>\n`;
                xml += `    <shuffleanswers>true</shuffleanswers>\n`;
                xml += `    <answernumbering>abc</answernumbering>\n`;
                xml += `    <correctfeedback format="html"><text>Your answer is correct.</text></correctfeedback>\n`;
                xml += `    <partiallycorrectfeedback format="html"><text>Your answer is partially correct.</text></partiallycorrectfeedback>\n`;
                xml += `    <incorrectfeedback format="html"><text>Your answer is incorrect.</text></incorrectfeedback>\n`;
                
                (q.options || []).forEach((option, i) => {
                    const isCorrect = (q.answer || []).includes(i);
                    const fraction = isCorrect ? correctFraction : (isMulti ? -100 : 0);
                    xml += `    <answer fraction="${fraction}" format="html">\n`;
                    xml += `      <text><![CDATA[<p>${option}</p>]]></text>\n`;
                    xml += `      <feedback format="html"><text></text></feedback>\n`;
                    xml += `    </answer>\n`;
                });
                
                xml += `  </question>\n`;
            });
            
            xml += `</quiz>`;
            return xml;
        }

    </script>
</body>
</html>