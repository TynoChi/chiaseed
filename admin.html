<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Analytics Dashboard</title>
    <link href="favicon.ico" rel="icon" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/admin.css">    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-inner" style="max-width: 100%; padding: 0 2rem;">
            <div class="logo">
                <span style="color: var(--primary); font-weight: 900; font-size: 1.4rem;">CHIASEED</span> <span style="font-weight: 400; opacity: 0.6;">ADMIN</span>
            </div>
            <div class="flex gap-6 items-center">
                <div id="global-stats" style="font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em;"></div>
                <button class="btn-icon" id="theme-toggle" style="background: var(--bg-body); width: 40px; height: 40px; border-radius: 12px; border: 1px solid var(--border);">üåô</button>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="mode-tabs-grid" style="grid-template-columns: 1fr;">
                    <button class="mode-btn active" id="tab-individual">Students</button>
                </div>
                <button class="mode-btn w-full mb-4" id="tab-overall" style="background: var(--bg-body); color: var(--text-main); margin-bottom: 0.5rem;">üåç Heatmap</button>
                <button class="mode-btn w-full mb-4" id="tab-weakness" style="background: var(--bg-body); color: var(--text-main); margin-bottom: 0.5rem;">üìâ Weakness</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button class="mode-btn" id="tab-leaderboard">üèÜ Rank</button>
                    <button class="mode-btn" id="tab-genai">ü§ñ GenAI</button>
                    <button class="mode-btn" id="tab-visualizer" style="grid-column: 1/-1;">üìä Visualizer</button>
                </div>
                <div style="position: relative; margin-top: 1.5rem;">
                    <input type="text" id="user-search" placeholder="Search accounts..." style="padding-left: 2.5rem; margin-bottom: 0;">
                    <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); opacity: 0.4;">üîç</span>
                </div>
            </div>
            <div class="user-list-container" id="user-list">
                <div class="text-center p-8"><div class="spinner"></div></div>
            </div>
        </aside>

        <main class="main-content">
            <div id="progress-view">
                <div class="dashboard-header">
                    <div class="dashboard-title">
                        <h2 id="selected-user-name">Welcome, Admin</h2>
                        <p id="selected-user-stats" class="sub-text">Select a student or view the global heatmap to begin analysis.</p>
                    </div>
                    <div class="flex flex-col gap-3 items-end" id="admin-view-controls">
                        <div class="flex gap-2">
                            <select id="time-filter" style="width: auto; padding: 0.4rem 1rem; font-size: 0.8rem; font-weight: 700; border-radius: 0.75rem; margin-bottom: 0;">
                                <option value="all">All Time</option>
                                <option value="24">Past 24h</option>
                                <option value="168">Past Week</option>
                                <option value="720">Past Month</option>
                            </select>
                            <label style="background: var(--bg-card); border: 1px solid var(--border); padding: 0.4rem 1rem; border-radius: 0.75rem; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; cursor: pointer;">
                                <input type="checkbox" id="chk-answered-only" style="width: auto; margin: 0;"> Answered
                            </label>
                        </div>
                        
                        <div class="controls-group">
                            <button class="control-btn active" id="btn-view-chapter">Chapters</button>
                            <button class="control-btn" id="btn-view-tag">Tags</button>
                        </div>
                        
                        <div class="controls-group hidden" id="tag-set-toggle">
                            <button class="control-btn active" id="btn-tag-clusters">AI Clusters</button>
                            <button class="control-btn" id="btn-tag-syllabus">Syllabus</button>
                        </div>

                        <div class="controls-group">
                            <button class="control-btn active" id="btn-source-qb">QB</button>
                            <button class="control-btn" id="btn-source-s11">S11</button>
                            <button class="control-btn" id="btn-source-s12">S12</button>
                            <button class="control-btn" id="btn-source-s2">S02</button>
                            <button class="control-btn" id="btn-source-all">All</button>
                        </div>
                    </div>
                </div>

                <div id="student-summary-card" class="stats-overview hidden">
                    <div class="stat-card">
                        <span class="label">Average Accuracy</span>
                        <span class="value" id="summary-accuracy">0%</span>
                        <span class="trend" style="color: var(--success);">Performance Grade</span>
                    </div>
                    <div class="stat-card">
                        <span class="label">Total Attempts</span>
                        <span class="value" id="summary-attempts">0</span>
                        <span class="trend" id="summary-last-date">-</span>
                    </div>
                    <div class="stat-card">
                        <span class="label">Knowledge Points</span>
                        <span class="value" id="summary-correct" style="color: var(--primary);">0</span>
                        <span class="trend">Correct Answers</span>
                    </div>
                </div>

                <div id="chapters-container" class="chapters-progress-container"></div>
            </div>

            <div id="leaderboard-view" class="hidden">
                <div class="flex justify-center gap-2 mb-6">
                    <div class="controls-group" style="padding: 0.25rem;">
                        <button class="control-btn active" onclick="window.leaderboardManager.fetchAndRender('all', this)">Combined</button>
                        <button class="control-btn" onclick="window.leaderboardManager.fetchAndRender('v2', this)">Standard (v2)</button>
                        <button class="control-btn" onclick="window.leaderboardManager.fetchAndRender('legacy', this)">Legacy</button>
                    </div>
                </div>
                <div class="podium-container">
                    <div class="podium-spot second" id="podium-second">
                        <span class="rank-badge">2</span>
                        <img alt="P" class="profile-picture" src="assets/img/profile-placeholder.svg"/>
                        <h4>-</h4>
                    </div>
                    <div class="podium-spot first" id="podium-first">
                        <span class="rank-badge">1</span>
                        <img alt="P" class="profile-picture" src="assets/img/profile-placeholder.svg"/>
                        <h4>-</h4>
                    </div>
                    <div class="podium-spot third" id="podium-third">
                        <span class="rank-badge">3</span>
                        <img alt="P" class="profile-picture" src="assets/img/profile-placeholder.svg"/>
                        <h4>-</h4>
                    </div>
                </div>
                <div class="card" style="padding: 0; overflow: hidden; border-radius: 1.5rem;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 80px; text-align: center;">Rank</th>
                                <th>Student Name</th>
                                <th style="text-align: center;">Correct</th>
                                <th style="text-align: center;">Total Time</th>
                                <th style="text-align: center;">Accuracy</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="weakness-view" class="hidden">
                <div class="flex flex-col gap-4 mb-6">
                    <div class="flex justify-between items-center">
                        <div class="controls-group" style="padding: 0.25rem;">
                             <button class="control-btn active" id="btn-weakness-config">Analysis Config</button>
                        </div>
                        <button id="btn-load-weakness" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">Run Analysis</button>
                    </div>
                    
                    <div id="weakness-config-panel" class="card hidden" style="padding: 1rem; border: 1px solid var(--border); background: var(--bg-body);">
                        <div class="flex gap-4 items-end">
                            <div class="input-group" style="flex:1;">
                                <label style="font-size:0.75rem;">Min Attempts</label>
                                <input type="number" id="inp-weak-min" value="3" min="1" style="padding:0.4rem; font-size:0.85rem; margin-bottom:0;">
                            </div>
                            <div class="input-group" style="flex:1;">
                                <label style="font-size:0.75rem;">Accuracy Threshold (%)</label>
                                <input type="number" id="inp-weak-acc" value="60" min="1" max="100" style="padding:0.4rem; font-size:0.85rem; margin-bottom:0;">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="weakness-results" class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                    <div class="text-center p-8 text-muted">Click "Run Analysis" to scan student attempts for pattern weaknesses.</div>
                </div>
            </div>
            
            <div id="genai-view" class="hidden"></div>
            
            <div id="visualizer-view" class="hidden">
                <div class="dashboard-header">
                    <div class="dashboard-title">
                        <h2>Data Visualizer</h2>
                        <p class="sub-text">Interactive charts for comprehensive performance analysis.</p>
                    </div>
                </div>
                
                <div class="stats-overview">
                     <div class="stat-card" style="grid-column: span 2;">
                        <span class="label">Daily Activity Trend</span>
                        <div style="height: 300px; width: 100%;"><canvas id="chart-daily"></canvas></div>
                     </div>
                </div>

                <div class="stats-overview">
                     <div class="stat-card" style="grid-column: span 2;">
                        <span class="label">Total Attempts (Overall)</span>
                        <div style="height: 300px; width: 100%;"><canvas id="chart-overall"></canvas></div>
                     </div>
                </div>

                <div class="stats-overview">
                     <div class="stat-card">
                        <span class="label">Student Accuracy Distribution</span>
                        <div style="height: 250px; width: 100%;"><canvas id="chart-student-dist"></canvas></div>
                     </div>
                     <div class="stat-card">
                        <span class="label">Time Efficiency (Avg Sec/Q)</span>
                        <div style="height: 250px; width: 100%;"><canvas id="chart-time"></canvas></div>
                     </div>
                </div>
            </div>

            <footer>
                <p>Developed by Tyno Chi & code002xcode016</p>
                <p style="opacity: 0.7; font-size: 0.75rem;">Special Thanks to Our Amazing Lecturers</p>
                <div style="text-align: center; font-size: 0.7rem; color: #888; margin-top: 5px;">Admin Analytics v1.1.0</div>
            </footer>
        </main>
    </div>

    <!-- Redesigned Detail Modal -->
    <div id="modal-detail" class="modal">
        <div class="modal-content">
            <div class="modal-header flex justify-between items-center">
                <div>
                    <span id="modal-id-badge" style="font-size: 0.7rem; font-weight: 800; color: var(--primary); text-transform: uppercase;">Question ID</span>
                    <h3 id="modal-title" style="margin-top: 0.25rem;">Analytics</h3>
                </div>
                <div id="modal-header-answer" style="background: var(--success-bg); color: var(--success); padding: 0.5rem 1rem; border-radius: 0.75rem; font-weight: 800; font-family: monospace; border: 1px solid var(--success); display: none;"></div>
                <button class="modal-close" onclick="document.getElementById('modal-detail').classList.remove('active')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-main">
                    <div class="detail-label mb-2">Question Context</div>
                    <div id="modal-question" style="font-size: 1rem; line-height: 1.6; color: var(--text-main); margin-bottom: 2rem;"></div>
                    
                    <div class="detail-label mb-2">Detailed Explanation</div>
                    <div id="modal-explanation" style="font-size: 0.9rem; color: var(--text-muted); background: var(--bg-body); padding: 1rem; border-radius: 1rem;"></div>
                </div>
                <div class="modal-side">
                    <div id="modal-user-status" class="mb-6">
                        <div class="detail-label mb-2">Last Result</div>
                        <div id="modal-status" class="status-badge" style="font-size: 1rem; padding: 0.5rem 1.5rem;">-</div>
                    </div>
                    
                    <div class="detail-label mb-2">Analytics Summary</div>
                    <div id="modal-attempt-info"></div>
                    
                    <div class="mt-6">
                        <div class="detail-label mb-2">Correct Answer</div>
                        <div id="modal-answer" style="font-family: monospace; background: var(--success-bg); color: var(--success); padding: 1rem; border-radius: 0.75rem; font-weight: 800; text-align: center; border: 1px solid var(--success);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { init } from './assets/js/admin/dashboard.js';
        init();
    </script>
</body>
</html>